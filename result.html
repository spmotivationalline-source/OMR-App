<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .report-container { background: white; padding: 2rem; border-radius: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 500px; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; }
        .stat-label { color: #4b5563; }
        .stat-value { font-weight: 600; color: #1f2937; }
        .action-button { display: block; width: 100%; text-align: center; font-weight: bold; padding: 0.8rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: all 0.2s; }
        .action-button.share { background-color: #3b82f6; color: white; }
        .action-button.pdf { background-color: #22c55e; color: white; }
        .action-button.retry { background-color: #f97316; color: white; }
    </style>
</head>
<body>
    <div class="report-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">Performance Report</h1>
        <p id="exam-title-report" class="text-center text-gray-500 mb-6">-</p>
        <div class="divide-y divide-gray-200">
            <div class="stat-item"><span class="stat-label">Questions:</span><span id="q-count" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Correct:</span><span id="correct-val" class="stat-value text-green-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Wrong:</span><span id="wrong-val" class="stat-value text-red-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Not Attempted:</span><span id="not-attempted-val" class="stat-value text-gray-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Marks:</span><span id="marks-val" class="stat-value text-blue-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Accuracy:</span><span id="accuracy-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Percentage:</span><span id="percentage-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Duration:</span><span id="duration-val" class="stat-value">-</span></div>
        </div>
        <div class="mt-8 space-y-3">
            <button id="share-btn" class="action-button share">Share</button>
            <button id="pdf-btn" class="action-button pdf">Generate PDF Report</button>
            <a href="./create-omr.html" class="action-button retry">Retry</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('omrSettings'));
            const userAnswers = JSON.parse(localStorage.getItem('userAnswers'));
            const answerKey = JSON.parse(localStorage.getItem('correctAnswerKey'));

            if (!settings || !userAnswers || !answerKey) {
                document.querySelector('.report-container').innerHTML = `<h1 class="text-red-500 text-center">Error! Report data not found.</h1><a href="./index.html" class="block text-center mt-4 text-blue-600">Go to Home</a>`;
                return;
            }

            const totalQuestions = parseInt(settings.totalQuestions);
            const correctMarks = parseFloat(settings.correctMarks);
            const wrongMarks = parseFloat(settings.wrongMarks);

            let correctCount = 0, wrongCount = 0, notAttemptedCount = 0;
            for (let i = 1; i <= totalQuestions; i++) {
                if (userAnswers[i] === null) notAttemptedCount++;
                else if (userAnswers[i] === answerKey[i]) correctCount++;
                else wrongCount++;
            }

            const userScore = (correctCount * correctMarks) - (wrongCount * wrongMarks);
            const totalScore = totalQuestions * correctMarks;
            const attemptedCount = correctCount + wrongCount;
            const percentage = totalScore > 0 ? ((userScore / totalScore) * 100) : 0;
            const accuracy = attemptedCount > 0 ? ((correctCount / attemptedCount) * 100) : 0;

            let examDurationSeconds = 0;
            const timeTaken = localStorage.getItem('timeTaken');
            if (timeTaken) {
                const totalDuration = (parseInt(settings.duration) || 0) * 60;
                examDurationSeconds = totalDuration - (parseInt(timeTaken) + 1);
                if(examDurationSeconds < 0) examDurationSeconds = 0;
            }
            const dur_hr = String(Math.floor(examDurationSeconds / 3600)).padStart(2, '0');
            const dur_min = String(Math.floor((examDurationSeconds % 3600) / 60)).padStart(2, '0');
            const dur_sec = String(examDurationSeconds % 60).padStart(2, '0');
            const formattedDuration = `${dur_hr}:${dur_min}:${dur_sec}`;

            document.getElementById('exam-title-report').textContent = settings.title;
            document.getElementById('q-count').textContent = totalQuestions;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('wrong-val').textContent = wrongCount;
            document.getElementById('not-attempted-val').textContent = notAttemptedCount;
            document.getElementById('marks-val').textContent = `${userScore.toFixed(2)} / ${totalScore.toFixed(2)}`;
            document.getElementById('accuracy-val').textContent = `${accuracy.toFixed(2)}%`;
            document.getElementById('percentage-val').textContent = `${percentage.toFixed(2)}%`;
            document.getElementById('duration-val').textContent = formattedDuration;

            const currentExamData = {
                id: Date.now(),
                settings, userAnswers, answerKey,
                result: {
                    correctCount, wrongCount, notAttemptedCount, userScore, totalScore,
                    percentage: percentage.toFixed(2),
                    accuracy: accuracy.toFixed(2),
                    formattedDuration
                }
            };

            let pastExams = JSON.parse(localStorage.getItem('pastExams')) || [];
            if (!pastExams.some(exam => exam.id === currentExamData.id)) {
                pastExams.unshift(currentExamData);
                localStorage.setItem('pastExams', JSON.stringify(pastExams));
            }

            document.getElementById('pdf-btn').addEventListener('click', () => {
                localStorage.setItem('currentReportData', JSON.stringify(currentExamData));
                window.location.href = './pdf-report.html';
            });

            document.getElementById('share-btn').addEventListener('click', async () => {
                const shareText = `I scored ${userScore.toFixed(2)}/${totalScore.toFixed(2)} (${percentage.toFixed(1)}%) in the ${settings.title} exam! Check out this OMR app.`;
                try {
                    if (navigator.share) {
                        await navigator.share({ title: 'OMR Exam Result', text: shareText, url: window.location.href });
                    } else { alert('Share feature is not supported on your browser.'); }
                } catch (err) { console.error("Share failed:", err); }
            });
        });
    </script>
</body>
</html>

