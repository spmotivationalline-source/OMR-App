<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .report-container { background: white; padding: 2rem; border-radius: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 500px; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; }
        .stat-label { color: #4b5563; }
        .stat-value { font-weight: 600; color: #1f2937; }
        .action-button { display: block; width: 100%; text-align: center; font-weight: bold; padding: 0.8rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: all 0.2s; }
        .action-button.share { background-color: #3b82f6; color: white; }
        .action-button.pdf { background-color: #22c55e; color: white; }
        .action-button.retry { background-color: #f97316; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="report-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">Performance Report</h1>
        <p id="exam-title-report" class="text-center text-gray-500 mb-6">-</p>
        <div class="divide-y divide-gray-200">
            <div class="stat-item"><span class="stat-label">Questions:</span><span id="q-count" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Correct:</span><span id="correct-val" class="stat-value text-green-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Wrong:</span><span id="wrong-val" class="stat-value text-red-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Not Attempted:</span><span id="not-attempted-val" class="stat-value text-gray-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Marks:</span><span id="marks-val" class="stat-value text-blue-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Accuracy:</span><span id="accuracy-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Percentage:</span><span id="percentage-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Duration:</span><span id="duration-val" class="stat-value">-</span></div>
        </div>
        <div class="mt-8 space-y-3">
            <button id="share-btn" class="action-button share">Share</button>
            <button id="pdf-btn" class="action-button pdf"><span class="btn-text">Generate PDF Report</span><div class="loader"></div></button>
            <a href="./create-omr.html" class="action-button retry">Retry</a>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-container" class="fixed inset-0 bg-gray-200 z-50 hidden">
        <header class="bg-white shadow-md p-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="back-to-report-btn" class="text-gray-600 hover:text-gray-900" title="Back to Report">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Your Report</h2>
            </div>
            <div class="flex items-center gap-3">
                 <a href="./index.html" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm">Go to Home</a>
                <button id="download-pdf-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">Download PDF</button>
            </div>
        </header>
        <main class="w-full h-[calc(100vh-60px)]">
            <iframe id="pdf-viewer" class="w-full h-full border-0"></iframe>
        </main>
    </div>

    <script>
        window.jsPDF = window.jspdf.jsPDF;
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('omrSettings'));
            const userAnswers = JSON.parse(localStorage.getItem('userAnswers'));
            const answerKey = JSON.parse(localStorage.getItem('correctAnswerKey'));

            if (!settings || !userAnswers || !answerKey) {
                document.querySelector('.report-container').innerHTML = `<h1 class="text-red-500 text-center">Error! Report data not found. Please start a new exam.</h1><a href="./index.html" class="block text-center mt-4 text-blue-600">Go to Home</a>`;
                return;
            }

            const totalQuestions = parseInt(settings.totalQuestions);
            const correctMarks = parseFloat(settings.correctMarks);
            const wrongMarks = parseFloat(settings.wrongMarks);

            let correctCount = 0, wrongCount = 0, notAttemptedCount = 0;
            for (let i = 1; i <= totalQuestions; i++) {
                if (userAnswers[i] === null) notAttemptedCount++;
                else if (userAnswers[i] === answerKey[i]) correctCount++;
                else wrongCount++;
            }

            const userScore = (correctCount * correctMarks) - (wrongCount * wrongMarks);
            const totalScore = totalQuestions * correctMarks;
            const attemptedCount = correctCount + wrongCount;

            const percentage = totalScore > 0 ? ((userScore / totalScore) * 100) : 0;
            const accuracy = attemptedCount > 0 ? ((correctCount / attemptedCount) * 100) : 0;

            let examDurationSeconds = 0;
            const timeTaken = localStorage.getItem('timeTaken');
            if (timeTaken) {
                const totalDuration = (parseInt(settings.duration) || 0) * 60;
                examDurationSeconds = totalDuration - (parseInt(timeTaken) + 1);
                if(examDurationSeconds < 0) examDurationSeconds = 0;
            }
            const dur_hr = String(Math.floor(examDurationSeconds / 3600)).padStart(2, '0');
            const dur_min = String(Math.floor((examDurationSeconds % 3600) / 60)).padStart(2, '0');
            const dur_sec = String(examDurationSeconds % 60).padStart(2, '0');
            const formattedDuration = `${dur_hr}:${dur_min}:${dur_sec}`;

            document.getElementById('exam-title-report').textContent = settings.title;
            document.getElementById('q-count').textContent = totalQuestions;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('wrong-val').textContent = wrongCount;
            document.getElementById('not-attempted-val').textContent = notAttemptedCount;
            document.getElementById('marks-val').textContent = `${userScore.toFixed(2)} / ${totalScore.toFixed(2)}`;
            document.getElementById('accuracy-val').textContent = `${accuracy.toFixed(2)}%`;
            document.getElementById('percentage-val').textContent = `${percentage.toFixed(2)}%`;
            document.getElementById('duration-val').textContent = formattedDuration;

            const currentExamData = { id: Date.now(), settings, userAnswers, answerKey };
            let pastExams = JSON.parse(localStorage.getItem('pastExams')) || [];
            if (!pastExams.some(exam => exam.id === currentExamData.id)) {
                pastExams.unshift(currentExamData);
                localStorage.setItem('pastExams', JSON.stringify(pastExams));
            }

            // New PDF Preview Logic
            let generatedPdf = null;
            const pdfBtn = document.getElementById('pdf-btn');
            const pdfPreviewContainer = document.getElementById('pdf-preview-container');
            const reportContainer = document.querySelector('.report-container');
            const backToReportBtn = document.getElementById('back-to-report-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const pdfViewer = document.getElementById('pdf-viewer');

            pdfBtn.addEventListener('click', showPdfPreview);
            backToReportBtn.addEventListener('click', () => {
                pdfPreviewContainer.classList.add('hidden');
                reportContainer.style.display = 'block';
            });
            downloadPdfBtn.addEventListener('click', () => {
                if (generatedPdf) {
                    generatedPdf.save(`${settings.title}_Report.pdf`);
                }
            });

            function showPdfPreview() {
                pdfBtn.querySelector('.btn-text').style.display = 'none';
                pdfBtn.querySelector('.loader').style.display = 'block';
                pdfBtn.disabled = true;

                // Failsafe timer in case PDF generation hangs
                const generationTimeout = setTimeout(() => {
                    alert('Sorry, there was an error generating the PDF. Please try again.');
                    pdfBtn.querySelector('.btn-text').style.display = 'block';
                    pdfBtn.querySelector('.loader').style.display = 'none';
                    pdfBtn.disabled = false;
                    const tempEl = document.getElementById('pdf-temp-source');
                    if (tempEl) { document.body.removeChild(tempEl); }
                }, 15000); // 15-second timeout

                // Use a short timeout to ensure loader is rendered before blocking task
                setTimeout(() => {
                    let analysisHTML = '';
                    const optionChars = ['A', 'B', 'C', 'D', 'E'];
                    for (let i = 1; i <= totalQuestions; i++) {
                        const userAnswer = userAnswers[i], correctAnswer = answerKey[i];
                        let optionsHTML = '';
                        for (let j = 0; j < settings.options; j++) {
                            const optChar = optionChars[j];
                            let circleStyle = 'border: 1px solid #999; color: #333;';
                            if (userAnswer === null && optChar === correctAnswer) {
                                circleStyle = 'background-color: #d1d5db; color: #333; border: 1px solid #999;';
                            } else if (optChar === userAnswer && userAnswer === correctAnswer) {
                                circleStyle = 'background-color: #22c55e; color: white; border-color: #22c55e;';
                            } else if (optChar === userAnswer && userAnswer !== correctAnswer) {
                                circleStyle = 'background-color: #ef4444; color: white; border-color: #ef4444;';
                            }
                            optionsHTML += `<span style="width: 20px; height: 20px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 2px; font-size: 10px; ${circleStyle}">${optChar}</span>`;
                        }
                        analysisHTML += `<div style="display: inline-flex; width: 32%; align-items: center; padding: 4px; border-radius: 4px; box-sizing: border-box;"><span style="font-weight: bold; margin-right: 8px; min-width: 25px;">${i}.</span> ${optionsHTML}</div>`;
                    }

                    const pdfSourceHTML = `
                        <div style="font-family: sans-serif; color: #333; width: 650px; margin: auto; padding: 20px;">
                            <h1 style="font-size: 24px; text-align: center; margin: 0; color: #1E90FF;">${settings.title}</h1>
                            <p style="font-size: 12px; text-align: center; margin-top: 4px; color: #555;">${settings.description || ''}</p>
                            <hr style="border: 0; border-top: 1px solid #ccc; margin: 12px 0;">
                            <table style="width: 100%; font-size: 12px; line-height: 1.6; border-collapse: collapse;">
                                <tr>
                                    <td style="padding-right: 15px; vertical-align: top; width: 50%;">
                                        <div style="display: flex; justify-content: space-between;"><strong>Questions:</strong><span>${totalQuestions}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Correct:</strong><span>${correctCount}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Partially Correct:</strong><span>0</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Wrong:</strong><span>${wrongCount}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Not Attempted:</strong><span>${notAttemptedCount}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Marks for Correct:</strong><span>+${correctMarks}</span></div>
                                    </td>
                                    <td style="padding-left: 15px; vertical-align: top; width: 50%;">
                                        <div style="display: flex; justify-content: space-between;"><strong>Marks:</strong><span>${userScore.toFixed(2)} / ${totalScore.toFixed(2)}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Total Marks:</strong><span>${totalScore.toFixed(2)}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Accuracy:</strong><span>${accuracy.toFixed(2)}%</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Percentage:</strong><span>${percentage.toFixed(2)}%</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>Duration:</strong><span>${formattedDuration}</span></div>
                                        <div style="display: flex; justify-content: space-between;"><strong>-ve marking for wrong:</strong><span>-${wrongMarks}</span></div>
                                    </td>
                                </tr>
                            </table>
                            <hr style="border: 0; border-top: 1px solid #ccc; margin: 12px 0;">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; text-align:center;">OMR Analysis</h3>
                            <div style="font-size: 11px;">${analysisHTML}</div>
                            <hr style="border: 0; border-top: 1px solid #ccc; margin: 12px 0;">
                            <div style="font-size: 11px;"><h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold;">How to cross check answers?</h4><p style="margin: 2px 0;">Serial Number with <span style="color: red;">red*</span> color is marked for review</p><p style="margin: 2px 0;">Options with <span style="color: green;">green</span> color is correct chosen option</p><p style="margin: 2px 0;">Options with <span style="color: red;">red</span> color is incorrect chosen option</p><p style="margin: 2px 0;">Options with <span style="background-color: #d1d5db; border-radius:2px; padding: 0 2px;">grey</span> color is correct option but not chosen</p></div>
                        </div>`;
                    
                    const pdfSourceElement = document.createElement('div');
                    pdfSourceElement.id = 'pdf-temp-source';
                    pdfSourceElement.innerHTML = pdfSourceHTML;
                    pdfSourceElement.style.position = 'absolute';
                    pdfSourceElement.style.left = '-9999px';
                    document.body.appendChild(pdfSourceElement);

                    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
                    pdf.html(pdfSourceElement, {
                        callback: function(pdf) {
                            clearTimeout(generationTimeout); // Success, so clear the failsafe
                            generatedPdf = pdf;
                            const pdfDataUri = pdf.output('datauristring');
                            pdfViewer.src = pdfDataUri;
                            reportContainer.style.display = 'none';
                            pdfPreviewContainer.classList.remove('hidden');
                            pdfBtn.querySelector('.btn-text').style.display = 'block';
                            pdfBtn.querySelector('.loader').style.display = 'none';
                            pdfBtn.disabled = false;
                            document.body.removeChild(pdfSourceElement);
                        },
                        x: 15, y: 15, width: 416, windowWidth: 650
                    });
                }, 100);
            }
             document.getElementById('share-btn').addEventListener('click', async () => {
                const shareText = `I scored ${userScore.toFixed(2)}/${totalScore.toFixed(2)} (${percentage.toFixed(1)}%) in the ${settings.title} exam! Check out this OMR app.`;
                try {
                    if (navigator.share) {
                        await navigator.share({ title: 'OMR Exam Result', text: shareText, url: window.location.href });
                    } else {
                        alert('Share feature is not supported on your browser.');
                    }
                } catch (err) { console.error("Share failed:", err); }
            });
        });
    </script>
</body>
</html>

