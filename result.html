<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .report-container { background: white; padding: 2rem; border-radius: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 500px; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; }
        .stat-label { color: #4b5563; }
        .stat-value { font-weight: 600; color: #1f2937; }
        .action-button { display: block; width: 100%; text-align: center; font-weight: bold; padding: 0.8rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: all 0.2s; }
        .action-button.share { background-color: #3b82f6; color: white; }
        .action-button.pdf { background-color: #22c55e; color: white; }
        .action-button.retry { background-color: #f97316; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="report-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">Performance Report</h1>
        <p id="exam-title-report" class="text-center text-gray-500 mb-6">-</p>
        <div class="divide-y divide-gray-200">
            <div class="stat-item"><span class="stat-label">Questions:</span><span id="q-count" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Correct:</span><span id="correct-val" class="stat-value text-green-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Wrong:</span><span id="wrong-val" class="stat-value text-red-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Not Attempted:</span><span id="not-attempted-val" class="stat-value text-gray-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Marks:</span><span id="marks-val" class="stat-value text-blue-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Accuracy:</span><span id="accuracy-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Percentage:</span><span id="percentage-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Duration:</span><span id="duration-val" class="stat-value">-</span></div>
        </div>
        <div class="mt-8 space-y-3">
            <button id="share-btn" class="action-button share">Share</button>
            <button id="pdf-btn" class="action-button pdf"><span class="btn-text">Generate PDF Report</span><div class="loader"></div></button>
            <a href="./create-omr.html" class="action-button retry">Retry</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('omrSettings'));
            const userAnswers = JSON.parse(localStorage.getItem('userAnswers'));
            const answerKey = JSON.parse(localStorage.getItem('correctAnswerKey'));

            if (!settings || !userAnswers || !answerKey) {
                document.querySelector('.report-container').innerHTML = `<h1 class="text-red-500 text-center">Error! Report data not found. Please start a new exam.</h1><a href="./index.html" class="block text-center mt-4 text-blue-600">Go to Home</a>`;
                return;
            }

            const totalQuestions = parseInt(settings.totalQuestions);
            const correctMarks = parseFloat(settings.correctMarks);
            const wrongMarks = parseFloat(settings.wrongMarks);

            let correctCount = 0, wrongCount = 0, notAttemptedCount = 0;
            for (let i = 1; i <= totalQuestions; i++) {
                if (userAnswers[i] === null) notAttemptedCount++;
                else if (userAnswers[i] === answerKey[i]) correctCount++;
                else wrongCount++;
            }

            const userScore = (correctCount * correctMarks) - (wrongCount * wrongMarks);
            const totalScore = totalQuestions * correctMarks;
            const attemptedCount = correctCount + wrongCount;

            const percentage = totalScore > 0 ? ((userScore / totalScore) * 100) : 0;
            const accuracy = attemptedCount > 0 ? ((correctCount / attemptedCount) * 100) : 0;

            let examDurationSeconds = 0;
            const timeTaken = localStorage.getItem('timeTaken');
            if (timeTaken) {
                const totalDuration = (parseInt(settings.duration) || 0) * 60;
                examDurationSeconds = totalDuration - (parseInt(timeTaken) + 1);
                if(examDurationSeconds < 0) examDurationSeconds = 0;
            }

            const dur_hr = String(Math.floor(examDurationSeconds / 3600)).padStart(2, '0');
            const dur_min = String(Math.floor((examDurationSeconds % 3600) / 60)).padStart(2, '0');
            const dur_sec = String(examDurationSeconds % 60).padStart(2, '0');
            const formattedDuration = `${dur_hr}:${dur_min}:${dur_sec}`;

            document.getElementById('exam-title-report').textContent = settings.title;
            document.getElementById('q-count').textContent = totalQuestions;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('wrong-val').textContent = wrongCount;
            document.getElementById('not-attempted-val').textContent = notAttemptedCount;
            document.getElementById('marks-val').textContent = `${userScore.toFixed(2)} / ${totalScore.toFixed(2)}`;
            document.getElementById('accuracy-val').textContent = `${accuracy.toFixed(2)}%`;
            document.getElementById('percentage-val').textContent = `${percentage.toFixed(2)}%`;
            document.getElementById('duration-val').textContent = formattedDuration;
            
            const currentExamData = { id: Date.now(), settings, userAnswers, answerKey };
            let pastExams = JSON.parse(localStorage.getItem('pastExams')) || [];
            pastExams.unshift(currentExamData);
            localStorage.setItem('pastExams', JSON.stringify(pastExams));

            document.getElementById('share-btn').addEventListener('click', () => alert('Share functionality will be implemented in the final app.'));
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);

            function generatePDF() {
                const pdfBtn = document.getElementById('pdf-btn');
                pdfBtn.querySelector('.btn-text').style.display = 'none';
                pdfBtn.querySelector('.loader').style.display = 'block';
                pdfBtn.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pageWidth = pdf.internal.pageSize.getWidth();
                let y = 15;

                function addText(text, x, size, style, align = 'left') {
                    if (y > pageHeight - 15) {
                        pdf.addPage();
                        y = 15;
                    }
                    pdf.setFontSize(size).setFont(undefined, style);
                    if (align === 'center') {
                        const textWidth = pdf.getStringUnitWidth(text) * pdf.getFontSize() / pdf.internal.scaleFactor;
                        x = (pageWidth - textWidth) / 2;
                    }
                    pdf.text(text, x, y);
                }

                addText(settings.title, 0, 22, 'bold', 'center');
                y += 8;
                if (settings.description) {
                    addText(settings.description, 0, 12, 'normal', 'center');
                    y += 6;
                }
                pdf.setDrawColor(200, 200, 200);
                pdf.line(15, y, pageWidth - 15, y);
                y += 10;

                const col1X = 20, col2X = 110;
                let initialYForStats = y;
                let yCol1 = initialYForStats;

                addText('Performance Summary', col1X, 14, 'bold'); yCol1 += 8;
                addText(`Questions: ${totalQuestions}`, col1X, 11, 'normal'); yCol1 += 7;
                addText(`Correct: ${correctCount}`, col1X, 11, 'normal'); yCol1 += 7;
                addText(`Wrong: ${wrongCount}`, col1X, 11, 'normal'); yCol1 += 7;
                addText(`Not Attempted: ${notAttemptedCount}`, col1X, 11, 'normal'); yCol1 += 7;
                addText(`Marks for Correct: +${correctMarks}`, col1X, 11, 'normal'); yCol1 += 7;
                addText(`-ve marking for wrong: -${wrongMarks}`, col1X, 11, 'normal');

                let yCol2 = initialYForStats;
                addText('Result', col2X, 14, 'bold'); yCol2 += 8;
                addText(`Marks: ${userScore.toFixed(2)} / ${totalScore.toFixed(2)}`, col2X, 11, 'bold'); yCol2 += 7;
                addText(`Total Marks: ${totalScore.toFixed(2)}`, col2X, 11, 'normal'); yCol2 += 7;
                addText(`Accuracy: ${accuracy.toFixed(2)}%`, col2X, 11, 'normal'); yCol2 += 7;
                addText(`Percentage: ${percentage.toFixed(2)}%`, col2X, 11, 'normal'); yCol2 += 7;
                addText(`Duration: ${formattedDuration}`, col2X, 11, 'normal');
                
                y = Math.max(yCol1, yCol2) + 5;
                pdf.line(15, y, pageWidth - 15, y);
                y += 10;

                addText('OMR Analysis', 15, 16, 'bold');
                y += 8;

                for (let i = 1; i <= totalQuestions; i++) {
                    if (y > pageHeight - 15) {
                        pdf.addPage();
                        y = 15;
                        addText('OMR Analysis (continued)', 15, 16, 'bold');
                        y += 8;
                    }

                    const userAnswer = userAnswers[i];
                    const correctAnswer = answerKey[i];
                    const optionChars = ['A', 'B', 'C', 'D', 'E'];
                    let marksText = '';
                    
                    if (userAnswer === null) {
                        marksText = '0';
                        pdf.setFillColor(243, 244, 246); // gray-100
                        pdf.rect(15, y - 5, pageWidth - 30, 9, 'F');
                    } else if (userAnswer === correctAnswer) {
                        marksText = `+${correctMarks}`;
                    } else {
                        marksText = `-${wrongMarks}`;
                    }

                    pdf.setFontSize(11).setFont(undefined, 'bold');
                    pdf.text(`${i}.`, 18, y);

                    let optionX = 35;
                    for (let j = 0; j < settings.options; j++) {
                        const optChar = optionChars[j];
                        pdf.setLineWidth(0.3);
                        pdf.setDrawColor(150, 150, 150);
                        pdf.setTextColor(0, 0, 0);
                        let isFilled = false;
                        
                        if (optChar === userAnswer) {
                            if (userAnswer === correctAnswer) pdf.setFillColor(34, 197, 94); // green-500
                            else pdf.setFillColor(239, 68, 68); // red-500
                            pdf.setTextColor(255, 255, 255);
                            isFilled = true;
                        } else if (optChar === correctAnswer) {
                            pdf.setLineWidth(0.8);
                            pdf.setDrawColor(34, 197, 94); // green-500
                        }

                        pdf.circle(optionX + 2.5, y - 1.5, 3, isFilled ? 'FD' : 'D');
                        pdf.text(optChar, optionX + 1.5, y);
                        optionX += 12;
                    }
                    
                    pdf.setFontSize(11).setFont(undefined, 'bold');
                    if (marksText.startsWith('+')) pdf.setTextColor(22, 163, 74); // green-600
                    else if (marksText.startsWith('-')) pdf.setTextColor(220, 38, 38); // red-600
                    else pdf.setTextColor(107, 114, 128); // gray-500
                    
                    pdf.text(marksText, pageWidth - 20, y, { align: 'right' });
                    pdf.setTextColor(0, 0, 0);
                    y += 10;
                }

                pdf.save(`${settings.title}_Report.pdf`);
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 500);
            }
        });
    </script>
</body>
</html>

