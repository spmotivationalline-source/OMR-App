<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .report-container { background: white; padding: 2rem; border-radius: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 500px; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; }
        .stat-label { color: #4b5563; }
        .stat-value { font-weight: 600; color: #1f2937; }
        .action-button { display: block; width: 100%; text-align: center; font-weight: bold; padding: 0.8rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: all 0.2s; }
        .action-button.share { background-color: #3b82f6; color: white; }
        .action-button.pdf { background-color: #22c55e; color: white; }
        .action-button.retry { background-color: #f97316; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="report-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">Performance Report</h1>
        <p id="exam-title-report" class="text-center text-gray-500 mb-6">-</p>
        <div class="divide-y divide-gray-200">
            <div class="stat-item"><span class="stat-label">Questions:</span><span id="q-count" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Correct:</span><span id="correct-val" class="stat-value text-green-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Wrong:</span><span id="wrong-val" class="stat-value text-red-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Not Attempted:</span><span id="not-attempted-val" class="stat-value text-gray-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Marks:</span><span id="marks-val" class="stat-value text-blue-600">-</span></div>
            <div class="stat-item"><span class="stat-label">Accuracy:</span><span id="accuracy-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Percentage:</span><span id="percentage-val" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">Duration:</span><span id="duration-val" class="stat-value">-</span></div>
        </div>
        <div class="mt-8 space-y-3">
            <button id="share-btn" class="action-button share">Share</button>
            <button id="pdf-btn" class="action-button pdf"><span class="btn-text">Generate PDF Report</span><div class="loader"></div></button>
            <a href="./create-omr.html" class="action-button retry">Retry</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('omrSettings'));
            const userAnswers = JSON.parse(localStorage.getItem('userAnswers'));
            const answerKey = JSON.parse(localStorage.getItem('correctAnswerKey'));

            if (!settings || !userAnswers || !answerKey) {
                document.querySelector('.report-container').innerHTML = `<h1 class="text-red-500 text-center">Error! Report data not found. Please start a new exam.</h1><a href="./index.html" class="block text-center mt-4 text-blue-600">Go to Home</a>`;
                return;
            }

            const totalQuestions = parseInt(settings.totalQuestions);
            const correctMarks = parseFloat(settings.correctMarks);
            const wrongMarks = parseFloat(settings.wrongMarks);

            let correctCount = 0, wrongCount = 0, notAttemptedCount = 0;
            for (let i = 1; i <= totalQuestions; i++) {
                if (userAnswers[i] === null) notAttemptedCount++;
                else if (userAnswers[i] === answerKey[i]) correctCount++;
                else wrongCount++;
            }

            const userScore = (correctCount * correctMarks) - (wrongCount * wrongMarks);
            const totalScore = totalQuestions * correctMarks;
            const attemptedCount = correctCount + wrongCount;

            const percentage = totalScore > 0 ? ((userScore / totalScore) * 100) : 0;
            const accuracy = attemptedCount > 0 ? ((correctCount / attemptedCount) * 100) : 0;

            let examDurationSeconds = 0;
            const timeTaken = localStorage.getItem('timeTaken');
            if (timeTaken) {
                const totalDuration = (parseInt(settings.duration) || 0) * 60;
                examDurationSeconds = totalDuration - (parseInt(timeTaken) + 1);
                if(examDurationSeconds < 0) examDurationSeconds = 0;
            }

            const dur_hr = String(Math.floor(examDurationSeconds / 3600)).padStart(2, '0');
            const dur_min = String(Math.floor((examDurationSeconds % 3600) / 60)).padStart(2, '0');
            const dur_sec = String(examDurationSeconds % 60).padStart(2, '0');
            const formattedDuration = `${dur_hr}:${dur_min}:${dur_sec}`;

            document.getElementById('exam-title-report').textContent = settings.title;
            document.getElementById('q-count').textContent = totalQuestions;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('wrong-val').textContent = wrongCount;
            document.getElementById('not-attempted-val').textContent = notAttemptedCount;
            document.getElementById('marks-val').textContent = `${userScore.toFixed(2)} / ${totalScore.toFixed(2)}`;
            document.getElementById('accuracy-val').textContent = `${accuracy.toFixed(2)}%`;
            document.getElementById('percentage-val').textContent = `${percentage.toFixed(2)}%`;
            document.getElementById('duration-val').textContent = formattedDuration;
            
            const currentExamData = { id: Date.now(), settings, userAnswers, answerKey };
            let pastExams = JSON.parse(localStorage.getItem('pastExams')) || [];
            pastExams.unshift(currentExamData);
            localStorage.setItem('pastExams', JSON.stringify(pastExams));

            document.getElementById('share-btn').addEventListener('click', () => alert('Share functionality will be implemented in the final app.'));
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);

            function generatePDF() {
                const pdfBtn = document.getElementById('pdf-btn');
                pdfBtn.querySelector('.btn-text').style.display = 'none';
                pdfBtn.querySelector('.loader').style.display = 'block';
                pdfBtn.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 15;
                let y = margin;

                function checkPageBreak() {
                    if (y > pageHeight - margin) {
                        pdf.addPage();
                        y = margin;
                    }
                }
                
                // Title and Description
                pdf.setFontSize(22).setFont(undefined, 'bold');
                pdf.text(settings.title, pageWidth / 2, y, { align: 'center' });
                y += 8;
                if (settings.description) {
                    pdf.setFontSize(12).setFont(undefined, 'normal');
                    pdf.text(settings.description, pageWidth / 2, y, { align: 'center' });
                    y += 6;
                }
                
                // First horizontal line
                y += 2;
                pdf.setDrawColor(200, 200, 200);
                pdf.line(margin, y, pageWidth - margin, y);
                y += 10;

                // Performance Summary
                const col1X = margin + 5;
                const col2X = pageWidth / 2 + 10;
                let y1 = y, y2 = y;
                const lineSpacing = 7;
                pdf.setFontSize(11).setFont(undefined, 'normal');
                
                pdf.text(`Questions: ${totalQuestions}`, col1X, y1); y1 += lineSpacing;
                pdf.text(`Correct: ${correctCount}`, col1X, y1); y1 += lineSpacing;
                pdf.text(`Partially Correct: 0`, col1X, y1); y1 += lineSpacing;
                pdf.text(`Wrong: ${wrongCount}`, col1X, y1); y1 += lineSpacing;
                pdf.text(`Not Attempted: ${notAttemptedCount}`, col1X, y1); y1 += lineSpacing;
                pdf.text(`Marks for correct: +${correctMarks}`, col1X, y1);
                
                pdf.text(`Marks: ${userScore.toFixed(2)}`, col2X, y2); y2 += lineSpacing;
                pdf.text(`Total Marks: ${totalScore.toFixed(2)}`, col2X, y2); y2 += lineSpacing;
                pdf.text(`Accuracy: ${accuracy.toFixed(2)}%`, col2X, y2); y2 += lineSpacing;
                pdf.text(`Percentage: ${percentage.toFixed(2)}%`, col2X, y2); y2 += lineSpacing;
                pdf.text(`Duration: ${formattedDuration}`, col2X, y2); y2 += lineSpacing;
                pdf.text(`-ve marking for wrong answer: -${wrongMarks}`, col2X, y2);

                y = Math.max(y1, y2) + 5;

                // Second horizontal line
                pdf.line(margin, y, pageWidth - margin, y);
                y += 10;
                
                // OMR Analysis
                pdf.setFontSize(16).setFont(undefined, 'bold');
                pdf.text('OMR Analysis', margin, y);
                y += 10;

                for (let i = 1; i <= totalQuestions; i++) {
                    checkPageBreak();
                    const userAnswer = userAnswers[i];
                    const correctAnswer = answerKey[i];
                    const optionChars = ['A', 'B', 'C', 'D', 'E'];
                    let marksText = '';

                    pdf.setFontSize(11).setFont(undefined, 'bold');
                    pdf.text(`${i}.`, margin + 3, y);
                    
                    let optionX = margin + 20;
                    for (let j = 0; j < settings.options; j++) {
                        const optChar = optionChars[j];
                        pdf.setLineWidth(0.3);
                        pdf.setDrawColor(100, 100, 100);
                        pdf.setTextColor(0, 0, 0);
                        let fillStyle = 'D'; // D for Draw

                        if (userAnswer === null) { // Not Attempted
                           if (optChar === correctAnswer) {
                                pdf.setFillColor(156, 163, 175); // gray-400
                                fillStyle = 'FD'; // Fill and Draw
                           }
                        } else if (optChar === userAnswer) { // Attempted
                            if (userAnswer === correctAnswer) { // Correct
                                pdf.setFillColor(34, 197, 94); // green-500
                            } else { // Wrong
                                pdf.setFillColor(239, 68, 68); // red-500
                            }
                            fillStyle = 'FD';
                            pdf.setTextColor(255, 255, 255);
                        } else if (userAnswer !== correctAnswer && optChar === correctAnswer) { // Correct answer when user was wrong
                            pdf.setFillColor(209, 213, 219); // gray-300
                            fillStyle = 'FD';
                        }
                        
                        pdf.circle(optionX + 2.5, y - 1.5, 3, fillStyle);
                        pdf.text(optChar, optionX + 1.5, y);
                        optionX += 12;
                    }
                    
                    y += 10;
                }

                // Third horizontal line
                checkPageBreak();
                y += 5;
                pdf.line(margin, y, pageWidth - margin, y);
                y += 8;

                // Legend
                checkPageBreak();
                pdf.setFontSize(12).setFont(undefined, 'bold');
                pdf.text('How to cross check answers?', margin, y);
                y += 7;
                
                pdf.setFontSize(10).setFont(undefined, 'normal');
                
                const legendText1_1 = 'Serial Number with ';
                const legendText1_2 = 'red';
                const legendText1_3 = ' color is marked for review';
                let textWidth = pdf.getStringUnitWidth(legendText1_1) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(legendText1_1, margin, y);
                pdf.setTextColor(255, 0, 0);
                pdf.text(legendText1_2, margin + textWidth, y);
                textWidth += pdf.getStringUnitWidth(legendText1_2) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.setTextColor(0, 0, 0);
                pdf.text(legendText1_3, margin + textWidth, y);
                y += 6;

                const legendText2_1 = 'Options with ';
                const legendText2_2 = 'green';
                const legendText2_3 = ' color is correct chosen option';
                textWidth = pdf.getStringUnitWidth(legendText2_1) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(legendText2_1, margin, y);
                pdf.setTextColor(0, 128, 0);
                pdf.text(legendText2_2, margin + textWidth, y);
                textWidth += pdf.getStringUnitWidth(legendText2_2) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.setTextColor(0, 0, 0);
                pdf.text(legendText2_3, margin + textWidth, y);
                y += 6;

                const legendText3_1 = 'Options with ';
                const legendText3_2 = 'red';
                const legendText3_3 = ' color is incorrect chosen option';
                textWidth = pdf.getStringUnitWidth(legendText3_1) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(legendText3_1, margin, y);
                pdf.setTextColor(255, 0, 0);
                pdf.text(legendText3_2, margin + textWidth, y);
                textWidth += pdf.getStringUnitWidth(legendText3_2) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.setTextColor(0, 0, 0);
                pdf.text(legendText3_3, margin + textWidth, y);
                y += 6;

                const legendText4_1 = 'Options with ';
                const legendText4_2 = 'grey';
                const legendText4_3 = ' color is correct option but not chosen';
                textWidth = pdf.getStringUnitWidth(legendText4_1) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(legendText4_1, margin, y);
                pdf.setTextColor(128, 128, 128);
                pdf.text(legendText4_2, margin + textWidth, y);
                textWidth += pdf.getStringUnitWidth(legendText4_2) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.setTextColor(0, 0, 0);
                pdf.text(legendText4_3, margin + textWidth, y);


                pdf.save(`${settings.title}_Report.pdf`);
                setTimeout(() => {
                    pdfBtn.querySelector('.btn-text').style.display = 'block';
                    pdfBtn.querySelector('.loader').style.display = 'none';
                    pdfBtn.disabled = false;
                    window.location.href = './index.html';
                }, 1000);
            }
        });
    </script>
</body>
</html>

