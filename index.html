<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        /* Mobile-first adjustments for a compact view */
        .app-container { 
            width: 100%; 
            max-width: 450px; 
            margin: 0.5rem auto; /* Reduced margin */
            display: flex; 
            flex-direction: column; 
            gap: 0.75rem; /* Reduced gap */
            padding: 0 0.5rem;
        }
        .card { 
            background: white; 
            border-radius: 1rem; /* Smaller radius */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 0.75rem; /* Reduced padding */
            border: 1px solid #e5e7eb; 
        }
        .header-bar { 
            background-color: #1E90FF; 
            color: white; 
            padding: 0.5rem 0.75rem; /* Reduced padding */
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .recent-exams-btn { 
            border: 1px solid white; 
            border-radius: 9999px; 
            padding: 0.125rem 0.625rem; 
            font-size: 0.75rem; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .hamburger-btn { cursor: pointer; }
        .stat-card { 
            padding: 0.5rem; /* Reduced padding */
            text-align: center; 
            flex: 1; 
        }
        .chart-container { 
            position: relative; 
            height: 160px; /* Reduced height */
            width: 100%; 
        }
        /* Modal and Side Menu Styles */
        .modal { transition: opacity 0.3s ease; }
        .side-menu { transition: transform 0.3s ease-in-out; }
        .recent-exam-item { cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; }
        .recent-exam-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="app-container">
        <header class="card header-bar">
            <div class="flex items-center">
                <div id="hamburger-btn" class="hamburger-btn space-y-1 mr-3"><div class="w-5 h-0.5 bg-white"></div><div class="w-5 h-0.5 bg-white"></div><div class="w-5 h-0.5 bg-white"></div></div>
                <h1 class="font-light text-lg">OMR App</h1>
            </div>
            <button id="recent-exams-btn" class="recent-exams-btn">RECENT Exams</button>
        </header>

        <!-- Chart Card 1: Exam Breakdown -->
        <div class="card">
            <h2 class="text-base font-semibold text-gray-700 mb-1 text-center">Latest Exam Breakdown</h2>
            <div id="chart1-container" class="chart-container">
                 <canvas id="exam-breakdown-chart"></canvas>
            </div>
             <p id="chart1-placeholder" class="h-40 flex items-center justify-center text-gray-400 text-sm text-center">Complete an exam to see the breakdown.</p>
        </div>
        
        <!-- Chart Card 2: Score Analysis -->
        <div class="card">
            <h2 class="text-base font-semibold text-gray-700 mb-1 text-center">Latest Score Analysis</h2>
            <div id="chart2-container" class="chart-container">
                <canvas id="score-analysis-chart"></canvas>
            </div>
            <p id="chart2-placeholder" class="h-40 flex items-center justify-center text-gray-400 text-sm text-center">Complete an exam to see your score.</p>
        </div>

        <!-- Latest Exam Stats Row -->
        <div class="flex space-x-2">
            <div class="card stat-card">
                <p id="latest-percentage" class="text-base font-bold text-gray-800">0.0%</p>
                <p class="text-xs text-gray-500">Percentage</p>
            </div>
            <div class="card stat-card">
                <p id="latest-accuracy" class="text-base font-bold text-gray-800">0.0%</p>
                <p class="text-xs text-gray-500">Accuracy</p>
            </div>
        </div>

        <a href="./create-omr.html" class="block text-center bg-[#1E90FF] text-white font-bold py-2.5 rounded-lg shadow-md hover:bg-blue-600 transition-colors flex-shrink-0">
            Start New Exam
        </a>
    </div>

    <!-- Side Menu (Hamburger Menu) -->
    <div id="side-menu" class="side-menu fixed top-0 left-0 h-full w-72 bg-white shadow-xl transform -translate-x-full z-50">
        <div class="p-5 border-b">
            <h2 class="text-2xl font-bold text-gray-800">OMR App Menu</h2>
        </div>
        <ul class="p-5 space-y-4 text-gray-700 font-semibold">
            <li class="hover:text-blue-600 cursor-pointer">Profile</li>
            <li class="hover:text-blue-600 cursor-pointer">Settings</li>
            <li class="hover:text-blue-600 cursor-pointer">About Us</li>
            <li class="hover:text-blue-600 cursor-pointer">Logout</li>
        </ul>
    </div>

    <!-- Recent Exams Modal -->
    <div id="recent-exams-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Recent Exams History</h2>
                <button id="close-recent-modal-btn" class="text-3xl font-light text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="recent-exams-list" class="overflow-y-auto p-4 space-y-2">
                <!-- List will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pastExams = JSON.parse(localStorage.getItem('pastExams')) || [];
            
            if (pastExams.length > 0) {
                document.getElementById('chart1-placeholder').style.display = 'none';
                document.getElementById('chart2-placeholder').style.display = 'none';

                const latestExam = pastExams[0];
                const { settings, userAnswers, answerKey } = latestExam;

                const totalQuestions = parseInt(settings.totalQuestions);
                const correctMarks = parseFloat(settings.correctMarks);
                const wrongMarks = parseFloat(settings.wrongMarks);

                let correctCount = 0, wrongCount = 0, notAttemptedCount = 0;
                for (let i = 1; i <= totalQuestions; i++) {
                    if (!userAnswers[i]) notAttemptedCount++;
                    else if (userAnswers[i] === answerKey[i]) correctCount++;
                    else wrongCount++;
                }

                const userScore = (correctCount * correctMarks) - (wrongCount * wrongMarks);
                const totalScore = totalQuestions * correctMarks;
                const attemptedCount = correctCount + wrongCount;
                const percentage = totalScore > 0 ? ((userScore / totalScore) * 100) : 0;
                const accuracy = attemptedCount > 0 ? ((correctCount / attemptedCount) * 100) : 0;

                document.getElementById('latest-percentage').textContent = `${percentage.toFixed(1)}%`;
                document.getElementById('latest-accuracy').textContent = `${accuracy.toFixed(1)}%`;

                const breakdownCtx = document.getElementById('exam-breakdown-chart').getContext('2d');
                new Chart(breakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Correct', 'Wrong', 'Not Attempted'],
                        datasets: [{
                            data: [correctCount, wrongCount, notAttemptedCount],
                            backgroundColor: ['#22c55e', '#ef4444', '#a8a29e'],
                            borderColor: ['#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
                
                const scoreCtx = document.getElementById('score-analysis-chart').getContext('2d');
                new Chart(scoreCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Your Score', 'Total Marks'],
                        datasets: [{
                            label: 'Marks',
                            data: [userScore.toFixed(2), totalScore.toFixed(2)],
                            backgroundColor: ['#3b82f6', '#e5e7eb'],
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });

            } else {
                document.getElementById('chart1-container').style.display = 'none';
                document.getElementById('chart2-container').style.display = 'none';
            }

            const hamburgerBtn = document.getElementById('hamburger-btn');
            const recentExamsBtn = document.getElementById('recent-exams-btn');
            const sideMenu = document.getElementById('side-menu');
            const recentExamsModal = document.getElementById('recent-exams-modal');
            const closeRecentModalBtn = document.getElementById('close-recent-modal-btn');
            const overlay = document.getElementById('overlay');

            function openMenu(element) {
                overlay.classList.remove('hidden');
                element.classList.remove('hidden');
            }

            function closeAll() {
                overlay.classList.add('hidden');
                sideMenu.classList.add('-translate-x-full');
                recentExamsModal.classList.add('hidden');
            }
            
            hamburgerBtn.addEventListener('click', () => {
                overlay.classList.remove('hidden');
                sideMenu.classList.remove('-translate-x-full');
            });

            recentExamsBtn.addEventListener('click', () => {
                populateRecentExams();
                openMenu(recentExamsModal);
            });

            closeRecentModalBtn.addEventListener('click', closeAll);
            overlay.addEventListener('click', closeAll);

            function populateRecentExams() {
                const pastExamsHistory = JSON.parse(localStorage.getItem('pastExams')) || [];
                const listContainer = document.getElementById('recent-exams-list');
                listContainer.innerHTML = '';

                if (pastExamsHistory.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500">No exam history found.</p>`;
                    return;
                }

                pastExamsHistory.forEach(examData => {
                    const item = document.createElement('div');
                    item.className = 'recent-exam-item flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${examData.settings.title}</p>
                            <p class="text-sm text-gray-500">${new Date(examData.id).toLocaleString()}</p>
                        </div>
                        <span class="text-blue-500 font-semibold">View &rarr;</span>
                    `;
                    item.addEventListener('click', () => {
                        localStorage.setItem('omrSettings', JSON.stringify(examData.settings));
                        localStorage.setItem('userAnswers', JSON.stringify(examData.userAnswers));
                        localStorage.setItem('correctAnswerKey', JSON.stringify(examData.answerKey));
                        window.location.href = './result.html';
                    });
                    listContainer.appendChild(item);
                });
            }
        });
    </script>
</body>
</html>

